<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>English → Arabic Speech (debug)</title>
<style>
  body { font-family: system-ui, sans-serif; padding: 18px; }
  textarea { width: 100%; max-width: 720px; min-height: 100px; }
  button { padding: 10px 14px; margin-top: 10px; }
  #ar { margin-top: 12px; font-size: 20px; direction: rtl; }
  #note { margin-top: 10px; font-size: 12px; opacity: .7; }
</style>
</head>
<body>
  <h2>English → Arabic Speech</h2>

  <textarea id="en" placeholder="Type English here...">Hello, how are you?</textarea><br>
  <button id="go">Translate & Speak Arabic</button>
  <button id="stop" disabled>Stop</button>

  <p id="ar"></p>
  <div id="note">Tip: Open DevTools (F12) to see detailed logs. If you hear nothing, install an Arabic voice (notes below).</div>

<script>
/* ===== Debug helpers ===== */
const DEBUG = true;
const log = (...a)=>DEBUG && console.log('[TTS]', ...a);
const info = (...a)=>DEBUG && console.info('[TTS]', ...a);
const warn = (...a)=>DEBUG && console.warn('[TTS]', ...a);
const err  = (...a)=>DEBUG && console.error('[TTS]', ...a);

/* ===== DOM ===== */
const goBtn = document.getElementById('go');
const stopBtn = document.getElementById('stop');
const enBox = document.getElementById('en');
const arOut = document.getElementById('ar');

/* ===== Utilities ===== */
function joinTranslated(data) {
  // Robust join of segments from translate.googleapis.com
  // data[0] is an array: [[translated, original, ...], ...]
  try {
    if (!Array.isArray(data) || !Array.isArray(data[0])) return '';
    const out = data[0].map(seg => Array.isArray(seg) ? (seg[0] || '') : '').join('');
    log('joinTranslated →', out);
    return out;
  } catch (e) {
    err('joinTranslated error:', e, data);
    return '';
  }
}

function waitForVoices() {
  return new Promise(resolve => {
    const existing = speechSynthesis.getVoices();
    if (existing && existing.length) return resolve(existing);
    speechSynthesis.onvoiceschanged = () => resolve(speechSynthesis.getVoices());
  });
}

function pickArabicVoice(voices) {
  const all = voices || [];
  log('Total voices available:', all.length);

  // Prefer voices whose lang starts with 'ar'
  const arVoices = all.filter(v => (v.lang || '').toLowerCase().startsWith('ar'));
  info('Arabic voices found:', arVoices.map(v => ({name:v.name, lang:v.lang, default:v.default, local:v.localService})));

  // Try some common Arabic voice names, then fall back to first Arabic voice.
  const preferredNames = ['Microsoft Hoda', 'Microsoft Naayf', 'Google العربية', 'Google ar'];
  for (const name of preferredNames) {
    const hit = arVoices.find(v => (v.name || '').toLowerCase().includes(name.toLowerCase()));
    if (hit) {
      info('Chosen Arabic voice by preference:', hit.name, hit.lang);
      return hit;
    }
  }
  if (arVoices[0]) {
    info('Chosen first available Arabic voice:', arVoices[0].name, arVoices[0].lang);
    return arVoices[0];
  }

  warn('No Arabic voices found. Speech may still try with ar lang but likely silent.');
  return null;
}

/* ===== Main flow ===== */
async function translateAndSpeak() {
  const text = enBox.value.trim();
  if (!text) return alert('Please type some English.');

  // ENV + sanity logs
  console.group('Translate & Speak run');
  info('UserAgent:', navigator.userAgent);
  info('Platform:', navigator.platform);
  info('Secure context:', window.isSecureContext);
  info('speechSynthesis supported:', !!window.speechSynthesis);
  info('Protocol:', location.protocol);

  // 1) Translate EN → AR
  const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=ar&dt=t&q=${encodeURIComponent(text)}`;
  goBtn.disabled = true;
  goBtn.textContent = 'Translating...';

  console.time('Translation fetch');
  try {
    log('Translation URL:', url);
    const res = await fetch(url);
    log('Translation status:', res.status, res.statusText);
    if (!res.ok) throw new Error('Non-OK translation response: ' + res.status);
    const data = await res.json();
    console.timeEnd('Translation fetch');
    log('Translation raw JSON:', data);

    const arabic = joinTranslated(data).trim();
    arOut.textContent = arabic || '(no translation)';
    info('Arabic text length:', arabic.length);

    if (!arabic) {
      warn('No Arabic text returned. Aborting speech.');
      return;
    }

    // 2) Speak Arabic via Web Speech API
    if (!('speechSynthesis' in window)) {
      err('speechSynthesis not supported in this browser.');
      alert('Your browser does not support speechSynthesis.');
      return;
    }

    console.time('Voices load');
    const voices = await waitForVoices();
    console.timeEnd('Voices load');

    // Dump voices table for debugging
    if (DEBUG && voices && voices.length) {
      try {
        console.table(voices.map(v => ({
          name: v.name, lang: v.lang, default: !!v.default,
          localService: !!v.localService, voiceURI: v.voiceURI
        })));
      } catch {}
    }

    const voice = pickArabicVoice(voices);

    // Build utterance
    const utt = new SpeechSynthesisUtterance(arabic);
    utt.lang = 'ar';   // critical
    utt.rate = 1.0;    // tweak as needed
    utt.pitch = 1.0;
    if (voice) utt.voice = voice;

    // Hook events for deep debugging
    utt.onstart = (e) => info('onstart', { elapsedTime: e.elapsedTime });
    utt.onend = (e) => { info('onend', { elapsedTime: e.elapsedTime }); stopBtn.disabled = true; console.groupEnd(); };
    utt.onerror = (e) => { err('onerror', e.error || e); stopBtn.disabled = true; console.groupEnd(); };
    utt.onpause = (e) => info('onpause', e);
    utt.onresume = (e) => info('onresume', e);
    utt.onmark = (e) => info('onmark', e);
    utt.onboundary = (e) => info('onboundary', { name: e.name, charIndex: e.charIndex });

    stopBtn.disabled = false;

    // Cancel any ongoing speech, then speak
    log('Cancel any current speech…');
    speechSynthesis.cancel();

    log('Speaking now…', { textPreview: arabic.slice(0, 48) + (arabic.length>48?'…':'') });
    speechSynthesis.speak(utt);

  } catch (e) {
    console.timeEnd('Translation fetch');
    err('translateAndSpeak error:', e);
    alert('Translation or speech failed. Check console for details.');
    console.groupEnd();
  } finally {
    goBtn.disabled = false;
    goBtn.textContent = 'Translate & Speak Arabic';
  }
}

/* ===== Wire up buttons ===== */
goBtn.addEventListener('click', () => {
  info('Go button clicked.');
  translateAndSpeak();
});
stopBtn.addEventListener('click', () => {
  info('Stop button clicked. Cancelling speech.');
  speechSynthesis.cancel();
  stopBtn.disabled = true;
});

/* ===== Extra debug helpers (call these from DevTools) ===== */
window.dumpVoices = async function() {
  const v = await waitForVoices();
  console.table(v.map(x => ({ name:x.name, lang:x.lang, default:x.default, localService:x.localService, uri:x.voiceURI })));
  return v;
};
window.testArabicVoice = async function(sampleText = 'مرحبا، هذا اختبار للصوت العربي.') {
  const voices = await waitForVoices();
  const voice = pickArabicVoice(voices);
  if (!voice) { warn('No Arabic voice installed.'); return; }
  const utt = new SpeechSynthesisUtterance(sampleText);
  utt.lang = 'ar';
  utt.voice = voice;
  speechSynthesis.cancel();
  speechSynthesis.speak(utt);
  info('Testing with voice:', voice.name, voice.lang);
};

/* ===== On load: environment log ===== */
(function bootLog(){
  console.group('Environment');
  info('UA:', navigator.userAgent);
  info('Language:', navigator.language);
  info('Languages:', navigator.languages);
  info('Protocol:', location.protocol, 'Host:', location.host);
  info('speechSynthesis present:', !!window.speechSynthesis);
  console.groupEnd();
})();
</script>

<hr>
<h4>If you hear nothing:</h4>
<ol>
  <li><b>Windows (Edge/Chrome):</b> Settings → Time & Language → <i>Speech</i> → <b>Manage voices</b> → <b>Add voices</b> → add <b>Arabic</b>. Restart the browser.</li>
  <li><b>Android (Chrome):</b> Settings → Accessibility → <i>Text-to-speech output</i> → Preferred engine (Speech Services by Google) → Install/Download <b>Arabic</b> voice.</li>
  <li><b>macOS:</b> System Settings → Accessibility → <i>Spoken Content</i> → System Voice → Manage Voices → add <b>Arabic</b>.</li>
  <li>Click the button (browsers require a user gesture to start audio).</li>
</ol>
</body>
</html>
